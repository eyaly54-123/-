<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioPro Cloud | Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { background-color: #030712; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .phone-container { width: 320px; height: 650px; border: 12px solid #1f2937; border-radius: 48px; position: relative; overflow: hidden; background: #000; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.7); }
        .notch { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 140px; height: 25px; background: #1f2937; border-bottom-left-radius: 18px; border-bottom-right-radius: 18px; z-index: 50; }
        .link-card { transition: all 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Themes */
        .theme-classic { background: #050505; color: white; }
        .theme-ocean { background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); color: white; }
        .theme-sunset { background: linear-gradient(135deg, #4c1d95 0%, #db2777 100%); color: white; }
        .theme-minimal { background: #ffffff; color: #111; }
    </style>
</head>
<body>

    <div id="loginScreen" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#030712]">
        <div class="relative glass p-10 rounded-[3rem] w-full max-w-md text-center space-y-8 mx-4 shadow-2xl">
            <h1 class="text-4xl font-black">BioPro <span class="text-indigo-500">Cloud</span></h1>
            <div class="space-y-4">
                <button onclick="authAction('google')" class="w-full flex items-center justify-center gap-3 p-4 bg-white text-black rounded-2xl font-bold hover:bg-slate-200 transition">
                    <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" class="w-5 h-5"> המשך עם Google
                </button>
                <div class="opacity-20 text-xs text-white">או באמצעות אימייל</div>
                <input type="email" id="email" placeholder="אימייל" class="w-full bg-white/5 p-4 rounded-xl border border-white/10 outline-none text-center">
                <input type="password" id="pass" placeholder="סיסמה" class="w-full bg-white/5 p-4 rounded-xl border border-white/10 outline-none text-center">
                <button onclick="authAction('email')" class="w-full p-4 bg-indigo-600 rounded-2xl font-bold text-white">כניסה / הרשמה</button>
            </div>
        </div>
    </div>

    <div id="adminPanel" class="hidden min-h-screen">
        <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
            <span class="font-black italic text-indigo-500">BIOPRO PRO</span>
            <div class="flex gap-4">
                <button onclick="toggleShareMenu()" class="bg-indigo-600 px-4 py-2 rounded-full text-xs font-bold">שיתוף</button>
                <button onclick="auth.signOut()" class="text-slate-400"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-10 p-6">
            <div class="lg:col-span-7 space-y-6">
                <div class="glass p-8 rounded-[2.5rem] space-y-4">
                    <h3 class="font-bold text-indigo-400">פרופיל</h3>
                    <input type="text" id="nameIn" oninput="autoSave()" placeholder="שם מלא" class="w-full bg-black/40 p-4 rounded-xl border border-white/5">
                    <input type="text" id="phoneIn" oninput="autoSave()" placeholder="טלפון" class="w-full bg-black/40 p-4 rounded-xl border border-white/5">
                    <input type="text" id="imgIn" oninput="autoSave()" placeholder="תמונה URL" class="w-full bg-black/40 p-4 rounded-xl border border-white/5">
                    <div class="flex gap-2 pt-2">
                        <button onclick="setTheme('theme-classic')" class="w-8 h-8 rounded-full bg-black border border-white"></button>
                        <button onclick="setTheme('theme-ocean')" class="w-8 h-8 rounded-full bg-blue-900 border border-white"></button>
                        <button onclick="setTheme('theme-sunset')" class="w-8 h-8 rounded-full bg-pink-600 border border-white"></button>
                    </div>
                </div>

                <div class="glass p-8 rounded-[2.5rem] space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-indigo-400">קישורים</h3>
                        <button onclick="addNewLink()" class="text-xs bg-indigo-600/20 px-3 py-1 rounded-full">+ הוסף</button>
                    </div>
                    <div id="linksEditor" class="space-y-3"></div>
                </div>
            </div>

            <div class="lg:col-span-5 flex justify-center">
                <div class="sticky top-28 phone-container">
                    <div class="notch"></div>
                    <div id="previewScreen" class="h-full pt-14 px-6 flex flex-col items-center overflow-y-auto no-scrollbar">
                        <img id="pImg" src="" class="w-24 h-24 rounded-full object-cover border-4 border-white/10 shadow-xl">
                        <h2 id="pName" class="mt-4 text-xl font-bold"></h2>
                        <button onclick="downloadVCard()" class="mt-3 text-[10px] bg-white/10 px-4 py-1 rounded-full border border-white/10">שמור איש קשר</button>
                        <div id="pLinks" class="w-full mt-8 space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="shareModal" class="fixed inset-0 bg-black/90 z-[101] hidden flex items-center justify-center p-6">
        <div class="bg-zinc-900 p-8 rounded-[2rem] text-center space-y-6 max-w-sm w-full">
            <div id="qrcode" class="bg-white p-3 rounded-xl inline-block"></div>
            <button onclick="copyPublicLink()" class="block w-full p-3 bg-indigo-600 rounded-xl font-bold">העתק קישור</button>
            <button onclick="toggleShareMenu()" class="text-slate-500 text-sm">סגור</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCQ4JuNyv-OLszK57jgjxsQi4qlOuSJkq8",
            authDomain: "biopro-55077.firebaseapp.com",
            projectId: "biopro-55077",
            storageBucket: "biopro-55077.firebasestorage.app",
            messagingSenderId: "590826980798",
            appId: "1:590826980798:web:c9a587aa501d30b849a5ef"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let userData = { name: "", phone: "", img: "", theme: "theme-classic", links: [] };
        let saveTimeout;

        // Auth Logic
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').classList.remove('hidden');
                fetchUserData(user.uid);
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminPanel').classList.add('hidden');
            }
        });

        authAction

        async function fetchUserData(uid) {
            const doc = await db.collection("users").doc(uid).get();
            if (doc.exists) {
                userData = doc.data();
                document.getElementById('nameIn').value = userData.name || "";
                document.getElementById('phoneIn').value = userData.phone || "";
                document.getElementById('imgIn').value = userData.img || "";
                setTheme(userData.theme || 'theme-classic');
                renderEditor();
            }
            renderPreview();
        }

        // Helper: Social Styles
        function getSocialStyle(url) {
            const l = url.toLowerCase();
            if(l.includes('instagram')) return { icon: 'fa-brands fa-instagram', color: 'bg-[#E1306C]' };
            if(l.includes('tiktok')) return { icon: 'fa-brands fa-tiktok', color: 'bg-black' };
            if(l.includes('wa.me') || l.includes('whatsapp')) return { icon: 'fa-brands fa-whatsapp', color: 'bg-[#25D366]' };
            return { icon: 'fa-solid fa-link', color: 'bg-indigo-600' };
        }

        function renderEditor() {
            const container = document.getElementById('linksEditor');
            container.innerHTML = '';
            userData.links.forEach((link, i) => {
                const d = document.createElement('div');
                d.className = "flex gap-2 items-center bg-white/5 p-3 rounded-xl";
                d.innerHTML = `
                    <div class="flex-1 space-y-1">
                        <input oninput="updateLink(${i}, 't', this.value)" value="${link.t}" placeholder="כותרת" class="w-full bg-transparent text-sm font-bold outline-none">
                        <input oninput="updateLink(${i}, 'u', this.value)" value="${link.u}" placeholder="לינק" class="w-full bg-transparent text-xs text-indigo-400 outline-none">
                    </div>
                    <div class="text-[10px] opacity-30 text-center px-2">קליקים<br>${link.clicks || 0}</div>
                    <button onclick="removeLink(${i})" class="text-red-900"><i class="fa-solid fa-trash"></i></button>
                `;
                container.appendChild(d);
            });
        }

        function renderPreview() {
            document.getElementById('pName').innerText = userData.name || "השם שלך";
            document.getElementById('pImg').src = userData.img || "https://ui-avatars.com/api/?name=User";
            const container = document.getElementById('pLinks');
            container.innerHTML = '';

            // בתוך הלופ של ה-forEach ב-renderPreview:
const style = getSocialStyle(l.u || ""); // השורה הזו מחלצת את האייקון והצבע
const btn = document.createElement('a');
// הוספת הקלאסים הדינמיים:
btn.className = `flex items-center justify-between p-4 rounded-2xl shadow-lg ${style.color} text-white`;
btn.innerHTML = `
    <div class="flex items-center gap-3">
        <i class="${style.icon}"></i>
        <span>${l.t}</span>
    </div>`;
            
            userData.links.forEach((l, i) => {
                if(!l.t) return;
                const style = getSocialStyle(l.u || "");
                const btn = document.createElement('a');
                btn.href = l.u || "#";
                btn.target = "_blank";
                btn.className = `flex items-center justify-between p-4 rounded-2xl shadow-lg ${userData.theme === 'theme-minimal' ? 'bg-slate-100 text-black' : style.color + ' text-white'}`;
                btn.innerHTML = `<div class="flex items-center gap-3"><i class="${style.icon}"></i><span>${l.t}</span></div>`;
                btn.onclick = () => trackClick(auth.currentUser.uid, i);
                container.appendChild(btn);
            });
        }

        function updateLink(i, f, v) { userData.links[i][f] = v; autoSave(); }
        function addNewLink() { userData.links.push({t:'', u:'', clicks:0}); renderEditor(); }
        function removeLink(i) { userData.links.splice(i, 1); renderEditor(); autoSave(); }
        
        function setTheme(t) { 
            userData.theme = t; 
            document.getElementById('previewScreen').className = `h-full pt-14 px-6 flex flex-col items-center overflow-y-auto no-scrollbar ${t}`;
            autoSave(); 
        }

        function autoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                userData.name = document.getElementById('nameIn').value;
                userData.phone = document.getElementById('phoneIn').value;
                userData.img = document.getElementById('imgIn').value;
                db.collection("users").doc(auth.currentUser.uid).set(userData).then(renderPreview);
            }, 500);
        }

        function downloadVCard() {
            const v = `BEGIN:VCARD\nVERSION:3.0\nFN:${userData.name}\nTEL:${userData.phone}\nEND:VCARD`;
            const b = new Blob([v], {type:'text/vcard'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = "contact.vcf";
            a.click();
        }

async function trackClick(uid, linkIndex) {
    const userRef = db.collection("users").doc(uid);
    // זה המנגנון שמוודא שהספירה מדויקת גם אם 100 איש לוחצים בשנייה
    return db.runTransaction(async (transaction) => {
        const doc = await transaction.get(userRef);
        const links = doc.data().links;
        links[linkIndex].clicks = (links[linkIndex].clicks || 0) + 1;
        transaction.update(userRef, { links: links });
    });
}

        function toggleShareMenu() {
            const m = document.getElementById('shareModal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                const url = window.location.href.split('?')[0] + "?u=" + auth.currentUser.uid;
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), { text: url, width: 120, height: 120 });
            }
        }
    </script>
</body>
</html>
