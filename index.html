<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioPro Pro | Cloud Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap');
        body { background-color: #030712; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        /* עיצוב הטלפון */
        .phone-container { 
            width: 320px; height: 650px; border: 12px solid #1f2937; border-radius: 48px; 
            position: relative; overflow: hidden; background: #000; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.7);
        }
        .notch {
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 140px; height: 25px; background: #1f2937; border-bottom-left-radius: 18px; border-bottom-right-radius: 18px; z-index: 50;
        }

        .link-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .link-card:hover { transform: translateY(-3px) scale(1.02); filter: brightness(1.1); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Themes */
        .theme-classic { background: #050505; color: white; }
        .theme-ocean { background: linear-gradient(135deg, #0f172a 0%, #1e40af 100%); color: white; }
        .theme-sunset { background: linear-gradient(135deg, #4c1d95 0%, #db2777 100%); color: white; }
        .theme-minimal { background: #ffffff; color: #111; }
        .theme-minimal .link-card { background: #f3f4f6; color: #111; border: 1px solid #e5e7eb; }
    </style>
</head>
<body class="antialiased">

<div id="loginScreen" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#030712]">
    <div class="relative glass p-10 rounded-[3rem] w-full max-w-md text-center space-y-8 mx-4 shadow-2xl">
        <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto rotate-3">
            <i class="fa-solid fa-bolt text-3xl text-white"></i>
        </div>
        <div>
            <h1 class="text-4xl font-black">BioPro <span class="text-indigo-500">Cloud</span></h1>
            <p class="text-slate-400 text-sm mt-2">ניהול נוכחות דיגיטלית מתקדם</p>
        </div>

        <div class="space-y-4">
            <button onclick="authAction('google')" class="w-full flex items-center justify-center gap-3 p-4 bg-white text-black rounded-2xl font-bold hover:bg-slate-200 transition shadow-lg">
                <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" class="w-5 h-5">
                המשך עם Google
            </button>

            <div class="flex items-center gap-4 py-2 opacity-20">
                <hr class="flex-1 border-white"> <span class="text-xs">או</span> <hr class="flex-1 border-white">
            </div>

            <input type="email" id="email" placeholder="אימייל" class="w-full bg-white/5 p-4 rounded-xl border border-white/10 outline-none focus:border-indigo-500 text-center text-white">
            <input type="password" id="pass" placeholder="סיסמה" class="w-full bg-white/5 p-4 rounded-xl border border-white/10 outline-none focus:border-indigo-500 text-center text-white">
            
            <button onclick="authAction('email')" class="w-full p-4 bg-indigo-600 rounded-2xl font-bold hover:bg-indigo-500 transition shadow-lg text-white">
                כניסה / הרשמה במייל
            </button>
        </div>
    </div>
</div>

    <div id="adminPanel" class="hidden min-h-screen">
        <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <span class="bg-indigo-600 px-3 py-1 rounded-md text-xs font-black italic text-white">PRO</span>
                <span id="userNameDisplay" class="text-sm font-bold opacity-70">משתמש</span>
            </div>
            <div class="flex gap-4">
                <button onclick="toggleShareMenu()" class="text-xs font-bold bg-indigo-600 text-white px-4 py-2 rounded-full hover:bg-indigo-500 transition">
                    <i class="fa-solid fa-share-nodes ml-2"></i> שיתוף
                </button>
                <button onclick="firebase.auth().signOut()" class="text-slate-500 hover:text-red-400 transition"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-10 p-6">
            <div class="lg:col-span-7 space-y-6">
                <div class="glass p-8 rounded-[2.5rem] space-y-6">
                    <h3 class="text-xl font-bold text-indigo-400 flex items-center gap-3"><i class="fa-solid fa-user-gear"></i> הגדרות פרופיל</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="nameIn" oninput="autoSave()" placeholder="שם מלא" class="bg-black/40 p-4 rounded-xl border border-white/5 outline-none text-white">
                        <input type="text" id="phoneIn" oninput="autoSave()" placeholder="טלפון (לשמירת איש קשר)" class="bg-black/40 p-4 rounded-xl border border-white/5 outline-none text-white">
                    </div>
                    <input type="text" id="imgIn" oninput="autoSave()" placeholder="תמונה URL" class="w-full bg-black/40 p-4 rounded-xl border border-white/5 outline-none text-white">
                    
                    <div class="space-y-3">
                        <label class="text-xs font-bold opacity-50">בחר ערכת נושא:</label>
                        <div class="flex gap-4">
                            <button onclick="setTheme('theme-classic')" class="w-10 h-10 rounded-full border-2 border-white theme-classic shadow-lg"></button>
                            <button onclick="setTheme('theme-ocean')" class="w-10 h-10 rounded-full border-2 border-white/10 theme-ocean shadow-lg"></button>
                            <button onclick="setTheme('theme-sunset')" class="w-10 h-10 rounded-full border-2 border-white/10 theme-sunset shadow-lg"></button>
                            <button onclick="setTheme('theme-minimal')" class="w-10 h-10 rounded-full border-2 border-white/10 theme-minimal shadow-lg"></button>
                        </div>
                    </div>
                </div>

                <div class="glass p-8 rounded-[2.5rem] space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-indigo-400">קישורים ורשתות</h3>
                        <button onclick="addNewLink()" class="bg-indigo-600/20 text-indigo-400 text-xs px-4 py-2 rounded-full font-bold hover:bg-indigo-600/30">+ הוסף קישור</button>
                    </div>
                    <div id="linksEditor" class="space-y-4"></div>
                </div>
            </div>

            <div class="lg:col-span-5">
                <div class="sticky top-28 flex flex-col items-center">
                    <div class="phone-container">
                        <div class="notch"></div>
                        <div id="previewScreen" class="h-full theme-classic overflow-y-auto no-scrollbar pt-14 px-6 pb-10 flex flex-col items-center">
                            <img id="pImg" src="https://ui-avatars.com/api/?name=User" class="w-24 h-24 rounded-full border-4 border-white/10 shadow-2xl object-cover">
                            <h2 id="pName" class="mt-6 text-2xl font-black">השם שלך</h2>
                            
                            <button onclick="downloadVCard()" class="mt-4 bg-white/10 px-4 py-2 rounded-full text-[10px] font-bold border border-white/10 hover:bg-white/20 transition">
                                <i class="fa-solid fa-address-book ml-2"></i> שמור איש קשר
                            </button>

                            <div id="pLinks" class="w-full mt-8 space-y-4"></div>
                        </div>
                    </div>
                    <div id="saveStatus" class="mt-4 text-xs text-slate-500 font-mono italic">כל השינויים מסונכרנים לענן</div>
                </div>
            </div>
        </div>
    </div>

    <div id="shareModal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-[101] hidden flex items-center justify-center p-4">
        <div class="bg-[#111] w-full max-w-md rounded-[2.5rem] p-8 space-y-8 animate-in zoom-in duration-300 relative">
            <button onclick="toggleShareMenu()" class="absolute top-6 left-6 text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            
            <div class="text-center space-y-2">
                <h3 class="text-2xl font-black text-white">שתף את הכרטיס שלך</h3>
                <p class="text-sm text-slate-400">הדרך המהירה ביותר להתחבר אליך</p>
            </div>

            <div id="qrcode" class="bg-white p-4 rounded-2xl mx-auto w-fit shadow-2xl border-4 border-indigo-600"></div>

            <div class="grid grid-cols-3 gap-4">
                <button onclick="shareTo('whatsapp')" class="flex flex-col items-center gap-2">
                    <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center text-xl text-white"><i class="fa-brands fa-whatsapp"></i></div>
                    <span class="text-[10px] font-bold">WhatsApp</span>
                </button>
                <button onclick="copyPublicLink()" class="flex flex-col items-center gap-2">
                    <div class="w-12 h-12 bg-slate-700 rounded-xl flex items-center justify-center text-xl text-white"><i class="fa-solid fa-link"></i></div>
                    <span class="text-[10px] font-bold">העתק לינק</span>
                </button>
                <button onclick="shareTo('facebook')" class="flex flex-col items-center gap-2">
                    <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-xl text-white"><i class="fa-brands fa-facebook-f"></i></div>
                    <span class="text-[10px] font-bold">Facebook</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCQ4JuNyv-OLszK57jgjxsQi4qlOuSJkq8",
            authDomain: "biopro-55077.firebaseapp.com",
            projectId: "biopro-55077",
            storageBucket: "biopro-55077.firebasestorage.app",
            messagingSenderId: "590826980798",
            appId: "1:590826980798:web:c9a587aa501d30b849a5ef"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let userData = { name: "", phone: "", img: "", theme: "theme-classic", links: [] };
        let saveTimeout;
        let qrInstance = null;

        // --- Auth ---
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('userNameDisplay').innerText = user.email;
                fetchUserData(user.uid);
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
            }
        });

        function authAction() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            if(!email || !pass) return alert("נא למלא אימייל וסיסמה");
            auth.signInWithEmailAndPassword(email, pass).catch(() => auth.createUserWithEmailAndPassword(email, pass));
        }

        async function fetchUserData(uid) {
            const doc = await db.collection("users").doc(uid).get();
            if (doc.exists) {
                userData = doc.data();
                document.getElementById('nameIn').value = userData.name || "";
                document.getElementById('phoneIn').value = userData.phone || "";
                document.getElementById('imgIn').value = userData.img || "";
                setTheme(userData.theme || 'theme-classic');
                renderEditor();
            } else {
                addNewLink();
            }
            renderPreview();
        }

        // --- Core Logic ---
        function renderEditor() {
            const container = document.getElementById('linksEditor');
            container.innerHTML = '';
            userData.links.forEach((link, index) => {
                const div = document.createElement('div');
                div.className = "glass p-4 rounded-2xl flex gap-3 items-center border border-white/5";
                div.innerHTML = `
                    <div class="flex-1">
                        <input type="text" value="${link.t}" placeholder="כותרת (למשל: אינסטגרם שלי)" oninput="updateLinkData(${index}, 't', this.value)" class="w-full bg-transparent outline-none font-bold text-sm text-white">
                        <input type="text" value="${link.u}" placeholder="קישור (URL)" oninput="updateLinkData(${index}, 'u', this.value)" class="w-full bg-transparent outline-none text-indigo-400 text-xs">
                    </div>
                    <div class="text-center px-4 border-r border-white/10">
                        <div class="text-[9px] opacity-40 uppercase">קליקים</div>
                        <div class="font-black text-indigo-500">${link.clicks || 0}</div>
                    </div>
                    <button onclick="removeLink(${index})" class="text-slate-600 hover:text-red-500 p-2"><i class="fa-solid fa-trash-can"></i></button>
                `;
                container.appendChild(div);
            });
        }

        function updateLinkData(index, field, value) {
            userData.links[index][field] = value;
            autoSave();
        }

        function setTheme(t) {
            userData.theme = t;
            document.getElementById('previewScreen').className = `h-full overflow-y-auto no-scrollbar pt-14 px-6 pb-10 flex flex-col items-center ${t}`;
            autoSave();
        }

        function autoSave() {
            document.getElementById('saveStatus').innerText = "שומר...";
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const user = auth.currentUser;
                userData.name = document.getElementById('nameIn').value;
                userData.phone = document.getElementById('phoneIn').value;
                userData.img = document.getElementById('imgIn').value;
                db.collection("users").doc(user.uid).set(userData).then(() => {
                    document.getElementById('saveStatus').innerText = "נשמר בענן ✓";
                    renderPreview();
                });
            }, 800);
        }

        // --- Features ---
        function downloadVCard() {
            const vcf = `BEGIN:VCARD\nVERSION:3.0\nFN:${userData.name}\nTEL:${userData.phone}\nEND:VCARD`;
            const blob = new Blob([vcf], { type: 'text/vcard' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${userData.name || 'contact'}.vcf`;
            a.click();
        }

        function toggleShareMenu() {
            const modal = document.getElementById('shareModal');
            const url = window.location.origin + window.location.pathname + "?u=" + auth.currentUser.uid;
            
            modal.classList.toggle('hidden');
            
            if(!modal.classList.contains('hidden')) {
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), { text: url, width: 160, height: 160 });
            }
        }

        function copyPublicLink() {
            const url = window.location.origin + window.location.pathname + "?u=" + auth.currentUser.uid;
            navigator.clipboard.writeText(url);
            alert("הלינק הועתק בהצלחה!");
        }

        function shareTo(p) {
            const url = window.location.origin + window.location.pathname + "?u=" + auth.currentUser.uid;
            if(p === 'whatsapp') window.open(`https://wa.me/?text=${encodeURIComponent(url)}`);
            if(p === 'facebook') window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`);
        }

        async function trackClick(uid, index) {
            const ref = db.collection("users").doc(uid);
            const doc = await ref.get();
            const data = doc.data();
            data.links[index].clicks = (data.links[index].clicks || 0) + 1;
            await ref.update({ links: data.links });
        }

    function getSocialStyle(url) {
    const lowUrl = url.toLowerCase();
    if(lowUrl.includes('instagram')) return { icon: 'fa-brands fa-instagram', color: 'bg-[#E1306C]' };
    if(lowUrl.includes('tiktok')) return { icon: 'fa-brands fa-tiktok', color: 'bg-black' };
    if(lowUrl.includes('whatsapp') || lowUrl.includes('wa.me')) return { icon: 'fa-brands fa-whatsapp', color: 'bg-[#25D366]' };
    if(lowUrl.includes('youtube')) return { icon: 'fa-brands fa-youtube', color: 'bg-[#FF0000]' };
    if(lowUrl.includes('facebook')) return { icon: 'fa-brands fa-facebook-f', color: 'bg-[#1877F2]' };
    if(lowUrl.includes('twitter') || lowUrl.includes('x.com')) return { icon: 'fa-brands fa-x-twitter', color: 'bg-black' };
    return { icon: 'fa-solid fa-link', color: 'bg-indigo-600' }; // ברירת מחדל
}

        function addNewLink() { userData.links.push({ t: "", u: "", clicks: 0 }); renderEditor(); }
        function removeLink(i) { userData.links.splice(i, 1); renderEditor(); autoSave(); }

        // --- Public View ---
        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            const uid = params.get('u');
            if (uid) {
                const doc = await db.collection("users").doc(uid).get();
                if(doc.exists) {
                    const data = doc.data();
                    document.body.innerHTML = `
                        <div class="flex items-center justify-center min-h-screen bg-black">
                            <div class="w-full max-w-md h-screen ${data.theme || 'theme-classic'} p-8 flex flex-col items-center shadow-2xl overflow-y-auto">
                                <img src="${data.img}" class="w-28 h-28 rounded-full border-4 border-white/10 shadow-2xl mt-12 object-cover">
                                <h1 class="text-3xl font-black mt-6">${data.name}</h1>
                                <button onclick="window.location.href='vcard'" class="mt-4 bg-white/10 px-6 py-2 rounded-full font-bold border border-white/10 text-xs">שמור איש קשר</button>
                                <div class="w-full mt-10 space-y-4">
                                    ${data.links.map((l, i) => `
                                        <a href="${l.u}" target="_blank" onclick="trackClick('${uid}', ${i})" class="flex items-center justify-between w-full p-5 rounded-2xl bg-white/10 font-bold shadow-lg border border-white/5">
                                            <span>${l.t}</span><i class="fa-solid fa-arrow-up-right-from-square text-xs opacity-30"></i>
                                        </a>`).join('')}
                                </div>
                                <div class="mt-auto py-10 opacity-20 text-[10px] uppercase tracking-widest font-bold">Created with BioPro Cloud</div>
                            </div>
                        </div>`;
                }
            }
        };

        function downloadVCard() {
    const name = userData.name || "איש קשר";
    const phone = userData.phone || "";
    
    // יצירת מבנה הקובץ שטלפונים מבינים
    const vcard = `BEGIN:VCARD
VERSION:3.0
FN:${name}
TEL;TYPE=CELL:${phone}
END:VCARD`;

    const blob = new Blob([vcard], { type: 'text/vcard' });
    const url = window.URL.createObjectURL(blob);
    const newLink = document.createElement('a');
    newLink.href = url;
    newLink.setAttribute('download', `${name}.vcf`);
    newLink.click();
}

        async function trackClick(uid, linkIndex) {
    // עדכון בבסיס הנתונים של פיירבייס
    const userRef = db.collection("users").doc(uid);
    
    db.runTransaction(async (transaction) => {
        const doc = await transaction.get(userRef);
        const links = doc.data().links;
        links[linkIndex].clicks = (links[linkIndex].clicks || 0) + 1;
        transaction.update(userRef, { links: links });
    });
}
    </script>
</body>
</html>
